<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style> body { margin: 0; overflow: hidden; background: #000; touch-action: none; } </style>
</head>
<body>
<script>
let player, bullets = [], enemies = [], bossBullets = [], fragments = [], boss;
let imgs = [];
let gameTimer = 0, BOSS_SPAWN_TIME = 20, gameOver = false;
let leftJoy = { active: false, id: -1, x: 0, y: 0, currX: 0, currY: 0 };
let rightJoy = { active: false, id: -1, x: 0, y: 0, currX: 0, currY: 0 };
let joySize = 130;

function preload() {
    // 這裡會載入你畫的四張怪物圖片，請確保檔名跟 GitHub 上一模一樣
    imgs[0] = loadImage('怪物1號.png');
    imgs[1] = loadImage('怪物二號.png');
    imgs[2] = loadImage('怪物三號.png');
    imgs[3] = loadImage('怪物四號.png');
}

function setup() { 
    createCanvas(windowWidth, windowHeight); 
    player = new Player(); 
}

function draw() {
    if (gameOver) {
        background(0, 180); fill(255, 50, 50); textAlign(CENTER); textSize(40);
        text("環境被廢棄物淹沒了！", width/2, height/2);
        textSize(20); fill(255); text("重新整理網頁挑戰", width/2, height/2 + 50);
        return;
    }
    background(15, 20, 30);
    gameTimer += deltaTime / 1000;
    handleInput();

    for (let i = fragments.length-1; i >= 0; i--) {
        fragments[i].update(); fragments[i].display();
        if (fragments[i].alpha <= 0) fragments.splice(i, 1);
    }

    player.update(); player.display();

    if (gameTimer >= BOSS_SPAWN_TIME && !boss) {
        boss = new StyrofoamTitan();
        enemies = [];
    } else if (!boss && frameCount % 60 === 0) {
        enemies.push(new NightMarketMonster());
    }

    if (boss) {
        boss.update(); boss.display();
        if (boss.hp <= 0) {
            noLoop(); background(0, 200); fill(0, 255, 100); textAlign(CENTER); textSize(35);
            text("成功淨化保麗龍泰坦！", width/2, height/2);
        }
    }
    handleCombat();
    drawUI();
    drawJoystick(leftJoy, color(0, 200, 255, 80));
    drawJoystick(rightJoy, color(255, 50, 50, 80));
}

// --- 控制系統 (支援手機搖桿) ---
function touchStarted() {
    for (let t of touches) {
        if (t.x < width/2 && !leftJoy.active) { leftJoy.active = true; leftJoy.id = t.id; leftJoy.x = t.x; leftJoy.y = t.y; leftJoy.currX = t.x; leftJoy.currY = t.y; }
        else if (t.x >= width/2 && !rightJoy.active) { rightJoy.active = true; rightJoy.id = t.id; rightJoy.x = t.x; rightJoy.y = t.y; rightJoy.currX = t.x; rightJoy.currY = t.y; }
    }
    return false;
}
function touchMoved() {
    for (let t of touches) {
        if (t.id === leftJoy.id) { leftJoy.currX = t.x; leftJoy.currY = t.y; }
        if (t.id === rightJoy.id) { rightJoy.currX = t.x; rightJoy.currY = t.y; }
    }
    return false;
}
function touchEnded() {
    let sL = false, sR = false;
    for (let t of touches) { if (t.id === leftJoy.id) sL = true; if (t.id === rightJoy.id) sR = true; }
    if (!sL) leftJoy.active = false; if (!sR) rightJoy.active = false;
    return false;
}
function handleInput() {
    if (leftJoy.active) {
        let a = atan2(leftJoy.currY - leftJoy.y, leftJoy.currX - leftJoy.x);
        let d = min(dist(leftJoy.x, leftJoy.y, leftJoy.currX, leftJoy.currY), joySize/2);
        player.vx += cos(a) * (d/(joySize/2)) * 1.5;
        player.vy += sin(a) * (d/(joySize/2)) * 1.5;
    }
    if (rightJoy.active && frameCount % 8 === 0) {
        let a = atan2(rightJoy.currY - rightJoy.y, rightJoy.currX - rightJoy.x);
        if (dist(rightJoy.x, rightJoy.y, rightJoy.currX, rightJoy.currY) > 20) {
            bullets.push(new Bullet(player.x, player.y, a));
        }
    }
}

class Player {
    constructor() { this.x = width/2; this.y = height*0.8; this.vx = 0; this.vy = 0; this.hp = 100; }
    update() {
        this.vx *= 0.9; this.vy *= 0.9;
        this.x += this.vx; this.y += this.vy;
        this.x = constrain(this.x, 20, width-20);
        this.y = constrain(this.y, 20, height-20);
    }
    display() {
        push(); translate(this.x, this.y);
        fill(0, 150, 255); stroke(255); rect(-15, -15, 30, 30, 5);
        fill(255); noStroke(); ellipse(0, -5, 10, 6);
        pop();
    }
}

class NightMarketMonster {
    constructor() {
        this.x = random(width); this.y = -50; this.hp = 3;
        this.imgIndex = floor(random(4));
    }
    update() {
        let a = atan2(player.y-this.y, player.x-this.x);
        this.x += cos(a)*2.5; this.y += sin(a)*2.5;
    }
    display() {
        imageMode(CENTER);
        image(imgs[this.imgIndex], this.x, this.y, 50, 50);
    }
}

class StyrofoamTitan {
    constructor() {
        this.x = width/2; this.y = -100; this.targetY = 150;
        this.hp = 200; this.maxHp = 200;
    }
    update() {
        if (this.y < this.targetY) this.y += 2;
        this.x = width/2 + sin(frameCount*0.02)*120;
        if (frameCount % 4 === 0) fragments.push(new Fragment(this.x + random(-60, 60), this.y + random(-40, 40)));
        if (frameCount % 45 === 0) bossBullets.push(new Skewer(this.x, this.y, atan2(player.y-this.y, player.x-this.x)));
        if (this.hp < 100 && frameCount % 12 === 0) {
            for(let i=0; i<3; i++) bossBullets.push(new MicroPlastic(this.x, this.y, frameCount*0.1 + (TWO_PI/3)*i));
        }
    }
    display() {
        push(); translate(this.x, this.y);
        fill(245); stroke(200); strokeWeight(2);
        rect(-50, -40, 100, 80, 5);
        fill(255, 50, 50, 200); ellipse(0, 0, 40, 35);
        fill(0); ellipse(-15, -15, 8, 12); ellipse(15, -15, 8, 12);
        pop();
    }
}

class MicroPlastic {
    constructor(x, y, a) { this.x = x; this.y = y; this.a = a; }
    update() { this.x += cos(this.a)*4; this.y += sin(this.a)*4; }
    display() { fill(255); noStroke(); rect(this.x, this.y, 6, 6); }
}

class Skewer {
    constructor(x, y, a) { this.x = x; this.y = y; this.a = a; }
    update() { this.x += cos(this.a)*6; this.y += sin(this.a)*6; }
    display() { fill(255, 255, 0); push(); translate(this.x, this.y); rotate(this.a); rect(0, -2, 25, 4); pop(); }
}

class Fragment {
    constructor(x, y) { this.x = x; this.y = y; this.vy = random(1, 4); this.alpha = 255; }
    update() { this.y += this.vy; this.alpha -= 4; }
    display() { fill(255, this.alpha); noStroke(); rect(this.x, this.y, 8, 8); }
}

class Bullet {
    constructor(x, y, a) { this.x = x; this.y = y; this.a = a; }
    update() { this.x += cos(this.a)*15; this.y += sin(this.a)*15; }
    display() { fill(0, 255, 200); noStroke(); ellipse(this.x, this.y, 12, 12); }
}

function handleCombat() {
    for (let i = bullets.length-1; i >= 0; i--) {
        bullets[i].update(); bullets[i].display();
        if (boss && dist(bullets[i].x, bullets[i].y, boss.x, boss.y) < 60) { boss.hp -= 4; bullets.splice(i, 1); continue; }
        for (let j = enemies.length-1; j >= 0; j--) {
            if (dist(bullets[i].x, bullets[i].y, enemies[j].x, enemies[j].y) < 25) {
                enemies[j].hp--; bullets.splice(i, 1);
                if (enemies[j].hp <= 0) enemies.splice(j, 1); break;
            }
        }
    }
    for (let e of enemies) { e.update(); e.display(); if (dist(e.x, e.y, player.x, player.y) < 30) player.hp -= 0.5; }
    for (let i = bossBullets.length-1; i >= 0; i--) {
        bossBullets[i].update(); bossBullets[i].display();
        if (dist(bossBullets[i].x, bossBullets[i].y, player.x, player.y) < 20) { player.hp -= 10; bossBullets.splice(i, 1); }
        else if (bossBullets[i].y > height) bossBullets.splice(i, 1);
    }
    if (player.hp <= 0) gameOver = true;
}

function drawJoystick(joy, col) {
    if (joy.active) {
        fill(col); noStroke(); ellipse(joy.x, joy.y, joySize);
        let a = atan2(joy.currY - joy.y, joy.currX - joy.x);
        let d = min(dist(joy.x, joy.y, joy.currX, joy.currY), joySize/2);
        fill(255, 150); ellipse(joy.x + cos(a)*d, joy.y + sin(a)*d, 60);
    }
}

function drawUI() {
    fill(255); textSize(18); textAlign(LEFT); noStroke();
    text(`機器人能源: ${floor(player.hp)}%`, 30, height - 40);
    if (boss) {
        fill(255, 50); rect(30, 30, 200, 10);
        fill(255, 50, 50); rect(30, 30, (boss.hp/boss.maxHp)*200, 10);
        text("泰坦血量 (200)", 30, 60);
    }
}
</script>
</body>
</html>
